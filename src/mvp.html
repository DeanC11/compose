<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Compose</title>
</head>
<body>
<div id="default"></div>

<script id="compose">
//+ mainHtml {"type": "html", "target": "default"}
//  <h1>Compose</h1>
//  <p>Compose is a tool for creating and editing scripts.</p>
//  <p>It is a work in progress.</p>
//  <input type="radio" name="mode" value="wholeScript" id="whole script" checked>
//  <label for="whole script">Whole script</label>
//  <input type="radio" name="mode" value="cell" id="cell">
//  <label for="cell">Cell</label>
//  <select id="cellNames" style="visibility: hidden;">
//    <option value="mainHtml">mainHtml</option>
//  </select>
//  <br>
//  <textarea id="editor" style="width: 80ch; height: 16ch;"></textarea>
//  <br>
//  <button id="store">store</button>
//  <button id="execute">store and execute</button>

//+ initializationCode
function updateTextArea(text) {
  textarea = document.getElementById('editor');
  textarea.value = text;
  textarea.style.height = Math.min(textarea.scrollHeight, 20 * 16) + 'px';
}


function updateScript(text) {
  let script = document.createElement('script');
  script.id = 'compose';
  let scriptText = document.createTextNode(text);
  script.appendChild(scriptText);
  document.body.appendChild(script);
}

function editableCellContent(type, storableContent) {
  if(type == 'javascript')
    return storableContent;
  let lines = storableContent.split('\n');
  let result = '';
  for(const line of lines) {
    if(line.match(/^\/\//)) {
      result += line.substring(2) + '\n';
    }
  }
  return result;
}

function storableCellContent(type, editableContent) {
  if(type == 'javascript') {
    return editableContent;
  }
  let lines = editableContent.split('\n');
  let result = '';
  for(const line of lines) {
    result += '//' + line + '\n';
  }
  return result;
}

function parseHeader(line) {
  if(!line.trim().match(/^\/\/\+[ ]*[a-zA-Z0-9_]+/))
    return null;
  let cellName = line.match(/[a-zA-Z0-9_]+/)[0];
  let cellAttributes = JSON.parse((line.match(/\{.*\}/) || ['{"type": "javascript"}'])[0]);
  return { "name": cellName, "attributes": cellAttributes };
}

function trimScript(text) {
  text = text.split('\/\/--BEGIN');
  text = text[text.length - 1].split('\/\/--END')[0];
  return text.trim();
}

function parseCells(text) {
  var cells = {};
  var lines = trimScript(text).split('\n');
  var cellName = '';
  for(const line of lines) {
    header = parseHeader(line);
    if(header) {
      cells[header.name] = { "attributes": header.attributes, "content": ''};
      cellName = header.name;
      continue;
    }
    cells[cellName].content += line + '\n';
  }
  return cells;
}

function stringifyCells(cells) {
  var text = '';
  for(const cellName of Object.keys(cells)) {
    text += '//+ ' + cellName + JSON.stringify(cells[cellName].attributes) + '\n';
    text += cells[cellName].content;
  }
  return text;
}

function storeCell() {
  let cellName = document.getElementById('cellNames').value;
  let cellContent = document.getElementById('editor').value;
  cells[cellName].content = storableCellContent(cells[cellName].attributes.type, cellContent);
}

function storeWholeScript() {
  let updated_script = document.getElementById('editor').value;
  cells = parseCells(updated_script);
}

function execute() {
  currentScript = document.getElementById('compose').innerHTML;
  newScript = stringifyCells(cells);
  document.body.innerHTML = '<div id="default"></div>';
  try{
    new Function(newScript); // check if the script is valid
    updateScript(`
      try { initialized = false;
      \/\/--BEGIN
      ${newScript}
      \/\/--END
       } catch(e) {
         alert('Error while executing updated script\\n'+ e);
         if(! initialized) {
           document.getElementById('compose').remove();
           let script = document.createElement('script');
           script.id = 'compose';
           let scriptText = document.createTextNode(currentScript);
           script.appendChild(scriptText);
           document.body.appendChild(script);
         }
       }
    `);
  } catch(e) {
    alert('Updated script is not valid\n'+ e);
    updateScript(trimScript(currentScript));
  }
}

onSelectWholeScript = function() {
  document.getElementById('cellNames').style.visibility = 'hidden';
  updateTextArea(stringifyCells(cells));
  document.getElementById('store').onclick = storeWholeScript;
  document.getElementById('execute').onclick = function() {
    storeWholeScript();
    execute();
  }
}

onSelectCell = function() {
  let cellNames = Object.keys(cells);
  let select = document.getElementById('cellNames');
  select.options.length = 0;
  select.style.visibility = 'visible';
  for(const cellName of Object.keys(cells)) {
    let option = document.createElement('option');
    option.value = cellName;
    option.innerHTML = cellName;
    select.appendChild(option);
  }
  select.onchange = function() {
    let cellName = select.value;
    updateTextArea(editableCellContent(cells[cellName].attributes.type, cells[cellName].content));
  }
  document.getElementById('store').onclick = storeCell;
  document.getElementById('execute').onclick = function() {
    storeCell();
    execute();
  }
  updateTextArea(editableCellContent(cells[cellNames[0]].attributes.type, cells[cellNames[0]].content));
}

var cells = parseCells(document.getElementById('compose').innerHTML);

for(let [cellName, cell] of Object.entries(cells)) {
  if (cell.attributes.type == 'html') {
    target = document.getElementById(cell.attributes.target);
    target.innerHTML = editableCellContent(cell.attributes.type, cell.content);
  }
}

if(document.getElementById('whole script').checked) {
  onSelectWholeScript();
}
else if(document.getElementById('cell').checked) {
  onSelectCell();
}

document.getElementById('whole script').onclick = onSelectWholeScript;
document.getElementById('cell').onclick = onSelectCell;
initialized = true;
</script>
</body>
</html>
