<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Compose</title>
</head>
<body>
<div id="default"></div>

<script id="compose">
//+ mainHtml {"type": "html", "target": "default"}
//  <h1>Compose</h1>
//  <p>Compose is a tool for creating and editing scripts.</p>
//  <p>It is a work in progress.</p>
//  <input type="radio" name="mode" value="wholeScript" id="whole script" checked>
//  <label for="whole script">Whole script</label>
//  <input type="radio" name="mode" value="cell" id="cell">
//  <label for="cell">Cell</label>
//  <select id="cellNames" style="visibility: hidden;">
//    <option value="mainHtml">mainHtml</option>
//  </select>
//  <br>
//  <textarea id="editor" style="width: 80ch; height: 16ch;"></textarea>
//  <br>
//  <button id="store">update and store</button>

//+ initializationCode
  function updateTextArea(text) {
    textarea = document.getElementById('editor');
    textarea.value = text;
    textarea.style.height = Math.min(textarea.scrollHeight, 20 * 16) + 'px';
  } 

  function updateStoreButton(onstore) {
    document.getElementById('store').onclick = onstore;
  }

  function updateScript(text) {
    let script = document.createElement('script');
    script.id = 'compose';
    let scriptText = document.createTextNode(text);
    script.appendChild(scriptText);
    document.body.appendChild(script);
  }

function cellType(attributes) {
  return attributes.type || 'javascript';
}

function editableCellContent(type, storableContent) {
  if(type == 'javascript')
    return storableContent;
  let lines = storableContent.split('\n');
  let result = '';
  for(var i = 0; i < lines.length; i++) {
    if(lines[i].match(/^\/\//)) {
      result += lines[i].substring(2) + '\n';
    }
  }
  return result;
}

function storableCellContent(type, editableContent) {
  if(type == 'javascript') {
    return editableContent;
  }
  let lines = editableContent.split('\n');
  let result = '';
  for(var i = 0; i < lines.length; i++) {
    result += '//' + lines[i] + '\n';
  }
  return result;
}

function parseCells(text) {
  var cells = {};
  var lines = text.split('\n');
  var cellName = '';
  var cellContent = '';
  for(var i = 0; i < lines.length; i++) {
    if(lines[i].match(/^\/\/\+[ ]*[a-zA-Z0-9_]+/)) {
      if(cellName != '') {
        cells[cellName] = { "attributes": cellAttributes, "content": cellContent };
      }
      cellName = lines[i].match(/[a-zA-Z0-9_]+/)[0];
      cellAttributes = lines[i].match(/\{.*\}/);
      if (cellAttributes == null) {
        cellAttributes = {};
      } else {
        cellAttributes = JSON.parse(cellAttributes[0])
      }
      cellContent = '';
    }
    else {
      cellContent += lines[i] + '\n';
    }
  }
  if(cellName != '') {
    cells[cellName] = { "attributes": cellAttributes, "content": cellContent };
  }
  return cells;
}

function stringifyCells(cells) {
  var text = '';
  var cellNames = Object.keys(cells);
  for(var i = 0; i < cellNames.length; i++) {
    text += '//+ ' + cellNames[i] + JSON.stringify(cells[cellNames[i]].attributes) + '\n';
    text += cells[cellNames[i]].content;
  }
  return text;
}

  onSelectWholeScript = function() {
    document.getElementById('cellNames').style.visibility = 'hidden';
    updateTextArea(document.getElementById('compose').innerHTML);
    updateStoreButton(function() {
      let scriptText = document.getElementById('editor').value;
      document.body.innerHTML = '<div id="default"></div>';
      updateScript(scriptText);
    })
  }

  onSelectCell = function() {
    let whole_text = document.getElementById('compose').innerHTML;
    let cells = parseCells(whole_text);
    let cellNames = Object.keys(cells);
    let select = document.getElementById('cellNames');
    select.options.length = 0;
    select.style.visibility = 'visible';
    for(var i = 0; i < cellNames.length; i++) {
      let option = document.createElement('option');
      option.value = cellNames[i];
      option.innerHTML = cellNames[i];
      select.appendChild(option);
    }
    select.onchange = function() {
      let cellName = select.value;
      updateTextArea(editableCellContent(cellType(cells[cellName].attributes), cells[cellName].content));
    } 
    updateStoreButton(function() {
      let cellName = select.value;
      let cellContent = textarea.value;
      cells[cellName].content = storableCellContent(cellType(cells[cellName].attributes), cellContent);
      whole_text = stringifyCells(cells);
      document.body.innerHTML = '<div id="default"></div>';
      updateScript(whole_text);
    })
    updateTextArea(editableCellContent(cellType(cells[cellNames[0]].attributes), cells[cellNames[0]].content));
  }

  var cells = parseCells(document.getElementById('compose').innerHTML);
  var cellKeys = Object.keys(cells);

  for (var i = 0; i < cellKeys.length; i++) {
    cell = cells[cellKeys[i]];
    if (cellType(cell.attributes) == 'html') {
      target = document.getElementById(cell.attributes.target);
      target.innerHTML = editableCellContent(cellType(cell.attributes), cell.content);
    }
  }

  if(document.getElementById('whole script').checked) {
    onSelectWholeScript();
  }
  else if(document.getElementById('cell').checked) {
    onSelectCell();
  }

  document.getElementById('whole script').onclick = onSelectWholeScript;
  document.getElementById('cell').onclick = onSelectCell;
</script>
</body>
</html>
